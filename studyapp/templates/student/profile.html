{% extends "student/student_base.html" %}

{% block content %}
<section class="content-section" id="profileSection" aria-labelledby="profileHeading">
    <h1 class="section-title" id="profileHeading">Profile Management</h1>
    <p class="section-subtitle">Update your personal information and password.</p>

    <!-- Profile Picture Section -->
    <div class="settings-card" style="margin-bottom: 24px;">
        <h3 style="margin-top: 0; margin-bottom: 16px;">Profile Picture</h3>
        <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
            <div class="profile-picture-container" style="position: relative;">
                <div id="profilePicturePreview"
                    style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #e5e7eb; background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s;"
                    title="Click to upload profile picture">
                    {% if profile_picture_url %}
                    <img id="profilePictureImg" src="{{ profile_picture_url }}" alt="Profile Picture"
                        style="width: 100%; height: 100%; object-fit: cover; display: block;"
                        onerror="this.style.display='none'; document.getElementById('profilePictureIcon').style.display='block';" />
                    <i class="fas fa-user" id="profilePictureIcon"
                        style="font-size: 48px; color: #9ca3af; display: none;"></i>
                    {% else %}
                    <img id="profilePictureImg" src="" alt="Profile Picture"
                        style="width: 100%; height: 100%; object-fit: cover; display: none;"
                        onerror="this.style.display='none'; document.getElementById('profilePictureIcon').style.display='block';" />
                    <i class="fas fa-user" id="profilePictureIcon"
                        style="font-size: 48px; color: #9ca3af; display: block;"></i>
                    {% endif %}
                </div>
                <label for="profilePictureInput"
                    style="position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background: #1158e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s;"
                    onmouseover="this.style.background='#0d47c7'" onmouseout="this.style.background='#1158e5'">
                    <i class="fas fa-camera" style="color: white; font-size: 16px;"></i>
                </label>
                <input type="file" id="profilePictureInput" name="profilePictureInput" accept="image/*"
                    style="display: none;" />
            </div>
            <div style="flex: 1; min-width: 200px;">
                <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 0.875rem;">Upload a profile picture
                    to personalize your account.</p>
                <p style="margin: 0; color: #9ca3af; font-size: 0.75rem;">Recommended: Square image, max
                    5MB. JPG, PNG, or GIF.</p>
                <button type="button" id="removeProfilePictureBtn" class="ghost-button"
                    style="margin-top: 12px; display: none;">Remove Picture</button>
            </div>
        </div>
        <div id="profilePictureError" class="field-error" style="margin-top: 12px; display: none;"></div>
    </div>

    <form id="profileForm" class="settings-card">
        <div class="form-grid">
            <label class="input-field">
                <span>First Name <span class="required">*</span></span>
                <input type="text" id="firstName" name="firstName" class="form-input" autocomplete="given-name" required
                    value="{{ first_name }}" />
                <span class="field-error" id="firstNameError"></span>
            </label>
            <label class="input-field">
                <span>Last Name <span class="required">*</span></span>
                <input type="text" id="lastName" name="lastName" class="form-input" required value="{{ last_name }}" />
                <span class="field-error" id="lastNameError"></span>
            </label>
            <label class="input-field">
                <span>Title</span>
                <input type="text" id="title" name="title" class="form-input" />
            </label>
            <label class="input-field">
                <span>Email</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="email" id="email" name="email" class="form-input" autocomplete="email" readonly
                        style="flex: 1; background-color: #f3f4f6; cursor: not-allowed;" value="{{ email }}" />
                    <a href="#" id="editEmailLink" class="edit-link"
                        style="color: #1158e5; text-decoration: none; font-size: 0.875rem; white-space: nowrap;">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                </div>
            </label>
            <label class="input-field">
                <span>Phone Number</span>
                <input type="tel" id="phoneNumber" name="phoneNumber" class="form-input" autocomplete="tel"
                    value="{{ phone }}" />
                <span class="field-error" id="phoneNumberError"></span>
            </label>
            <label class="input-field">
                <span>Student ID</span>
                <input type="text" id="studentId" name="studentId" class="form-input" readonly
                    style="background-color: #f3f4f6; cursor: not-allowed;" value="{{ student_id }}" />
                <small style="display: block; margin-top: 4px; font-size: 0.75rem; color: #6b7280;">System
                    assigned ID</small>
            </label>
        </div>
        <div class="actions">
            <button type="submit" class="primary-button update-btn">Save changes</button>
            <button type="button" class="ghost-button" data-open-section="dashboard">Cancel</button>
        </div>
    </form>
    <br />
    <form id="passwordForm" class="settings-card">
        <h3 style="margin-top: 0; margin-bottom: 16px;">Change Password</h3>
        <div class="form-grid">
            <label class="input-field">
                <span>Current password</span>
                <input type="password" id="currentPassword" name="currentPassword" class="form-input"
                    autocomplete="current-password" />
                <span class="field-error" id="currentPasswordError"></span>
            </label>
            <label class="input-field">
                <span>New password</span>
                <input type="password" id="newPassword" name="newPassword" class="form-input"
                    autocomplete="new-password" />
                <span class="field-error" id="newPasswordError"></span>
            </label>
            <label class="input-field">
                <span>Confirm password</span>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-input"
                    autocomplete="new-password" />
                <span class="field-error" id="confirmPasswordError"></span>
            </label>
        </div>
        <div class="actions">
            <button type="submit" class="primary-button update-password-btn">Update password</button>
        </div>
    </form>
</section>

<script>
    (function () {
        // Get CSRF token from cookie or meta tag
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            // Fallback to meta tag if cookie not found
            if (!cookieValue) {
                const metaTag = document.querySelector('meta[name="csrf-token"]');
                if (metaTag) {
                    cookieValue = metaTag.getAttribute('content');
                }
            }
            return cookieValue;
        }

        // Load profile data on page load
        async function loadProfileData() {
            try {
                const response = await fetch('/account/api/accounts/profile/', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.profile) {
                        const profile = data.profile;

                        // Fill form fields
                        document.getElementById('firstName').value = profile.first_name || '';
                        document.getElementById('lastName').value = profile.last_name || '';
                        document.getElementById('email').value = profile.email || '';
                        document.getElementById('phoneNumber').value = profile.phone || '';
                        document.getElementById('studentId').value = profile.student_id || '';

                        // Load profile picture
                        if (profile.profile_picture) {
                            const img = document.getElementById('profilePictureImg');
                            const icon = document.getElementById('profilePictureIcon');
                            img.src = profile.profile_picture;
                            img.style.display = 'block';
                            icon.style.display = 'none';
                            document.getElementById('removeProfilePictureBtn').style.display = 'block';
                        }
                    }
                } else {
                    console.error('Failed to load profile data');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Initialize profile picture display from Django template
        (function () {
            const profilePicUrl = '{{ profile_picture_url|default:"" }}';
            if (profilePicUrl) {
                const img = document.getElementById('profilePictureImg');
                const icon = document.getElementById('profilePictureIcon');
                const removeBtn = document.getElementById('removeProfilePictureBtn');
                if (img && icon) {
                    img.style.display = 'block';
                    icon.style.display = 'none';
                    if (removeBtn) removeBtn.style.display = 'block';
                }
            }
        })();

        // Profile form submission
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData();
                formData.append('first_name', document.getElementById('firstName').value.trim());
                formData.append('last_name', document.getElementById('lastName').value.trim());
                formData.append('email', document.getElementById('email').value.trim());
                const phoneValue = document.getElementById('phoneNumber').value.trim();
                if (phoneValue) {
                    formData.append('phone', phoneValue);
                }

                // Add profile picture if selected
                const profilePictureInput = document.getElementById('profilePictureInput');
                if (profilePictureInput.files.length > 0) {
                    formData.append('profile_picture', profilePictureInput.files[0]);
                }

                try {
                    const csrftoken = getCookie('csrftoken');
                    if (!csrftoken) {
                        alert('Error: CSRF token not found. Please refresh the page and try again.');
                        return;
                    }
                    const response = await fetch('/account/api/accounts/profile/', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        body: formData
                    });

                    // Check if response is ok before parsing JSON
                    if (!response.ok) {
                        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            // If response is not JSON, use status text
                        }
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();

                    if (data.success) {
                        // Update header name immediately
                        const firstName = document.getElementById('firstName').value.trim();
                        const headerName = document.getElementById('headerUserName');
                        if (headerName && firstName) {
                            headerName.textContent = firstName;
                        }

                        // Update header profile picture if changed
                        const profileImg = document.getElementById('profilePictureImg');
                        const headerProfileImg = document.getElementById('headerProfilePicture');
                        const headerProfileIcon = document.getElementById('headerProfileIcon');
                        if (profileImg && profileImg.src && headerProfileImg) {
                            headerProfileImg.src = profileImg.src;
                            headerProfileImg.style.display = 'block';
                            if (headerProfileIcon) headerProfileIcon.style.display = 'none';
                        }

                        alert('Profile updated successfully!');
                        // Optionally reload after a short delay to show updated data
                        // location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to update profile'));
                    }
                } catch (error) {
                    console.error('Error updating profile:', error);
                    const errorMessage = error.message || 'An error occurred. Please try again.';
                    alert('Error: ' + errorMessage);
                }
            });
        }

        // Password form submission
        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm) {
            passwordForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Clear previous errors
                document.querySelectorAll('#passwordForm .field-error').forEach(el => {
                    el.textContent = '';
                });

                try {
                    const csrftoken = getCookie('csrftoken');
                    if (!csrftoken) {
                        alert('Error: CSRF token not found. Please refresh the page and try again.');
                        return;
                    }
                    const response = await fetch('/account/api/accounts/change-password/', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                            current_password: currentPassword,
                            new_password: newPassword,
                            confirm_password: confirmPassword
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Password updated successfully!');
                        passwordForm.reset();
                    } else {
                        const errorMsg = data.error || 'Failed to update password';
                        alert('Error: ' + errorMsg);
                    }
                } catch (error) {
                    console.error('Error changing password:', error);
                    alert('An error occurred. Please try again.');
                }
            });
        }

        // Profile picture upload
        const profilePictureInput = document.getElementById('profilePictureInput');
        if (profilePictureInput) {
            profilePictureInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.getElementById('profilePictureImg');
                        const icon = document.getElementById('profilePictureIcon');
                        img.src = e.target.result;
                        img.style.display = 'block';
                        icon.style.display = 'none';
                        document.getElementById('removeProfilePictureBtn').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Remove profile picture
        const removeProfilePictureBtn = document.getElementById('removeProfilePictureBtn');
        if (removeProfilePictureBtn) {
            removeProfilePictureBtn.addEventListener('click', async function () {
                if (confirm('Are you sure you want to remove your profile picture?')) {
                    try {
                        const formData = new FormData();
                        formData.append('remove_profile_picture', 'true');

                        const csrftoken = getCookie('csrftoken');
                        if (!csrftoken) {
                            alert('Error: CSRF token not found. Please refresh the page and try again.');
                            return;
                        }
                        const response = await fetch('/account/api/accounts/profile/', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'X-CSRFToken': csrftoken
                            },
                            body: formData
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Update UI
                            document.getElementById('profilePictureImg').style.display = 'none';
                            document.getElementById('profilePictureIcon').style.display = 'block';
                            document.getElementById('profilePictureInput').value = '';
                            this.style.display = 'none';

                            // Update header profile picture
                            const headerProfileImg = document.getElementById('headerProfilePicture');
                            const headerProfileIcon = document.getElementById('headerProfileIcon');
                            if (headerProfileImg && headerProfileIcon) {
                                headerProfileImg.style.display = 'none';
                                headerProfileIcon.style.display = 'flex';
                            }

                            alert('Profile picture removed successfully!');
                        } else {
                            alert('Error: ' + (data.error || 'Failed to remove profile picture'));
                        }
                    } catch (error) {
                        console.error('Error removing profile picture:', error);
                        alert('An error occurred. Please try again.');
                    }
                }
            });
        }

        // Email edit toggle
        const editEmailLink = document.getElementById('editEmailLink');
        const emailInput = document.getElementById('email');
        if (editEmailLink && emailInput) {
            editEmailLink.addEventListener('click', function (e) {
                e.preventDefault();
                if (emailInput.readOnly) {
                    emailInput.readOnly = false;
                    emailInput.style.backgroundColor = '#ffffff';
                    emailInput.style.cursor = 'text';
                    this.innerHTML = '<i class="fas fa-check"></i> Done';
                } else {
                    emailInput.readOnly = true;
                    emailInput.style.backgroundColor = '#f3f4f6';
                    emailInput.style.cursor = 'not-allowed';
                    this.innerHTML = '<i class="fas fa-edit"></i> Edit';
                }
            });
        }

        // Profile data is already loaded from Django template variables
        // No need to call loadProfileData() since fields are pre-filled
    })();
</script>
{% endblock %}